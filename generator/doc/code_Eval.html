<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Builtin" rel="Chapter" href="Builtin.html">
<link title="Error" rel="Chapter" href="Error.html">
<link title="Eval" rel="Chapter" href="Eval.html">
<link title="Graph" rel="Chapter" href="Graph.html">
<link title="Helper" rel="Chapter" href="Helper.html">
<link title="Lambda_repl" rel="Chapter" href="Lambda_repl.html">
<link title="Modules" rel="Chapter" href="Modules.html">
<link title="Show" rel="Chapter" href="Show.html">
<link title="Syntax" rel="Chapter" href="Syntax.html">
<link title="Typing" rel="Chapter" href="Typing.html"><title>Eval</title>
</head>
<body>
<code class="code"></code><table><tr><td></td><td><span class="comment">(** Expression evaluation routines.
<p>

    Handles pattern matching &amp; expression reduction and evaluation. Some
    reduction (formal function reduction) is done by <code class="code"><span class="constructor">Lambda_repl</span></code>.
<p>

    TODO : Fix name clashes when redefining Prelude names.
  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Syntax</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Modules</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Lambda_repl</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Error</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Helper</span><br>
<br>
<span class="keyword">let</span>&nbsp;op_property&nbsp;prop&nbsp;op&nbsp;env&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;op_prop&nbsp;(lookup_env&nbsp;op&nbsp;env)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Error</span>&nbsp;<span class="string">"tried&nbsp;to&nbsp;get&nbsp;op&nbsp;properties&nbsp;from&nbsp;a&nbsp;non-op&nbsp;object"</span>)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">List</span>.mem&nbsp;prop&nbsp;p<br>
<br>
<span class="keyword">let</span>&nbsp;is_com&nbsp;=&nbsp;op_property&nbsp;<span class="constructor">Com</span><br>
<span class="keyword">let</span>&nbsp;is_assoc&nbsp;=&nbsp;op_property&nbsp;<span class="constructor">Assoc</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Matches an expression against a pattern, and computes the new variables
    defined by the pattern. Returns a list of names and their values to be added
    to the environment.
<p>

    Operator properties (commutativity and associativity) are also handled here
    using the booleans <code class="code">com_test</code> and <code class="code">assoc_test</code> and the environment.
  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;matching&nbsp;(com_test,&nbsp;assoc_test)&nbsp;env&nbsp;value&nbsp;pattern&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;value,&nbsp;pattern&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(_,&nbsp;<span class="constructor">PAll</span>)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(value,&nbsp;<span class="constructor">PAxiom</span>&nbsp;id)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;value,&nbsp;lookup_env&nbsp;id&nbsp;env&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EVariable</span>&nbsp;v,&nbsp;(_,&nbsp;_)&nbsp;<span class="keyword">when</span>&nbsp;v&nbsp;=&nbsp;id&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(value,&nbsp;<span class="constructor">PVariable</span>&nbsp;id)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[(id,&nbsp;(<span class="constructor">Some</span>&nbsp;value,&nbsp;<span class="constructor">None</span>))]&nbsp;<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">EBoolean</span>&nbsp;b1,&nbsp;<span class="constructor">PBoolean</span>&nbsp;b2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;b1&nbsp;=&nbsp;b2&nbsp;<span class="keyword">then</span>&nbsp;[]&nbsp;<span class="keyword">else</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">ENum</span>&nbsp;i1,&nbsp;<span class="constructor">PNum</span>&nbsp;i2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;i1&nbsp;=&nbsp;i2&nbsp;<span class="keyword">then</span>&nbsp;[]&nbsp;<span class="keyword">else</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">EString</span>&nbsp;s1,&nbsp;<span class="constructor">PString</span>&nbsp;s2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;s1&nbsp;=&nbsp;s2&nbsp;<span class="keyword">then</span>&nbsp;[]&nbsp;<span class="keyword">else</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">EPair</span>(v1,&nbsp;v2),&nbsp;<span class="constructor">PPair</span>&nbsp;(m1,&nbsp;m2))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;v1&nbsp;m1&nbsp;@&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;v2&nbsp;m2<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">ENil</span>,&nbsp;<span class="constructor">PNil</span>)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">ECons</span>&nbsp;(v1,&nbsp;v2),&nbsp;<span class="constructor">PCons</span>(m1,&nbsp;m2))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;v1&nbsp;m1&nbsp;@&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;v2&nbsp;m2<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">ENone</span>,&nbsp;<span class="constructor">PNone</span>)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">ESome</span>&nbsp;v,&nbsp;<span class="constructor">PSome</span>&nbsp;m)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;v&nbsp;m<br>
&nbsp;&nbsp;<br>
<span class="comment">(*<br>
|&nbsp;(_,&nbsp;POp("+",&nbsp;a,&nbsp;PMinus&nbsp;b))&nbsp;when&nbsp;not&nbsp;assoc_test&nbsp;-&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;(try<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matching&nbsp;(com_test,&nbsp;true)&nbsp;env&nbsp;value&nbsp;pattern&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;MatchingFailure&nbsp;-&gt;&nbsp;(print_endline&nbsp;"ok";&nbsp;matching&nbsp;(com_test,&nbsp;true)&nbsp;env&nbsp;value&nbsp;(POp("+",&nbsp;a,&nbsp;POp("*",&nbsp;PConst(PNum&nbsp;minus_one),&nbsp;b))))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;|&nbsp;(_,&nbsp;POp("+",&nbsp;a,&nbsp;POp("*",&nbsp;PConst(PNum&nbsp;minus_one),&nbsp;b)))&nbsp;when&nbsp;not&nbsp;assoc_test&nbsp;-&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;(try<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_endline&nbsp;"ok1";&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matching&nbsp;(com_test,&nbsp;true)&nbsp;env&nbsp;value&nbsp;pattern&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;MatchingFailure&nbsp;-&gt;&nbsp;(print_endline&nbsp;"ok";&nbsp;matching&nbsp;(com_test,&nbsp;true)&nbsp;env&nbsp;value&nbsp;(&nbsp;POp("+",&nbsp;a,&nbsp;PMinus&nbsp;b)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
*)</span>&nbsp;&nbsp;<br>
<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">POp</span>(op1,&nbsp;<span class="constructor">POp</span>(op2,&nbsp;a,&nbsp;b),&nbsp;c))&nbsp;<span class="keyword">when</span>&nbsp;op1&nbsp;=&nbsp;op2&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;is_assoc&nbsp;op1&nbsp;env&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;not&nbsp;assoc_test<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;matching&nbsp;(com_test,&nbsp;<span class="keyword">true</span>)&nbsp;env&nbsp;expr&nbsp;pattern&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">MatchingFailure</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;matching&nbsp;(com_test,&nbsp;<span class="keyword">true</span>)&nbsp;env&nbsp;expr&nbsp;&nbsp;(<span class="constructor">POp</span>(op1,&nbsp;a,&nbsp;<span class="constructor">POp</span>(op2,&nbsp;b,&nbsp;c)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">POp</span>(op1,&nbsp;a,&nbsp;<span class="constructor">POp</span>(op2,&nbsp;b,&nbsp;c)))&nbsp;<span class="keyword">when</span>&nbsp;op1&nbsp;=&nbsp;op2&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;is_assoc&nbsp;op1&nbsp;env&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;not&nbsp;assoc_test<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;matching&nbsp;(com_test,&nbsp;<span class="keyword">true</span>)&nbsp;env&nbsp;expr&nbsp;pattern&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">MatchingFailure</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;matching&nbsp;(com_test,&nbsp;<span class="keyword">true</span>)&nbsp;env&nbsp;expr&nbsp;&nbsp;(<span class="constructor">POp</span>(op1,&nbsp;<span class="constructor">POp</span>(op2,&nbsp;a,&nbsp;b),&nbsp;c))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">POp</span>(op,&nbsp;a,&nbsp;b))&nbsp;<span class="keyword">when</span>&nbsp;is_com&nbsp;op&nbsp;env&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;not&nbsp;com_test&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">try</span>&nbsp;matching&nbsp;(<span class="keyword">true</span>,&nbsp;assoc_test)&nbsp;env&nbsp;expr&nbsp;pattern&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">MatchingFailure</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;matching&nbsp;(<span class="keyword">true</span>,&nbsp;assoc_test)&nbsp;env&nbsp;expr&nbsp;(<span class="constructor">POp</span>(op,&nbsp;b,&nbsp;a))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">POp</span>(op,&nbsp;pf,&nbsp;pg))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;expr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EFunction</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EApplication</span>&nbsp;(<span class="constructor">EVariable</span>&nbsp;op',&nbsp;e1),&nbsp;e2)];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;=&nbsp;envi})&nbsp;<span class="keyword">when</span>&nbsp;op&nbsp;=&nbsp;op'&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="constructor">EFunction</span>({def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;e1];&nbsp;env&nbsp;=&nbsp;envi&nbsp;})&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="constructor">EFunction</span>({def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;e2];&nbsp;env&nbsp;=&nbsp;envi&nbsp;})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;(matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;f&nbsp;pf)&nbsp;@&nbsp;(matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;g&nbsp;pg)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">PMinus</span>&nbsp;m)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;expr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EFunction</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;({def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;<span class="constructor">EApplication</span>&nbsp;(<span class="constructor">EVariable</span>&nbsp;<span class="string">"-"</span>,&nbsp;e)];&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;=&nbsp;envi})&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f'&nbsp;=&nbsp;<span class="constructor">EFunction</span>({def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;e];&nbsp;env&nbsp;=&nbsp;envi&nbsp;})&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;f'&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">PCompose</span>(a,&nbsp;<span class="constructor">PCompose</span>(b,&nbsp;c)))&nbsp;<span class="keyword">when</span>&nbsp;not&nbsp;assoc_test&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;matching&nbsp;(com_test,&nbsp;<span class="keyword">true</span>)&nbsp;env&nbsp;expr&nbsp;pattern&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">MatchingFailure</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;matching&nbsp;(com_test,&nbsp;<span class="keyword">true</span>)&nbsp;env&nbsp;expr&nbsp;&nbsp;(<span class="constructor">PCompose</span>(<span class="constructor">PCompose</span>(a,&nbsp;b),&nbsp;c))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">PCompose</span>(<span class="constructor">PCompose</span>(a,&nbsp;b),&nbsp;c))&nbsp;<span class="keyword">when</span>&nbsp;not&nbsp;assoc_test&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;matching&nbsp;(com_test,&nbsp;<span class="keyword">true</span>)&nbsp;env&nbsp;expr&nbsp;pattern&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">MatchingFailure</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;matching&nbsp;(com_test,&nbsp;<span class="keyword">true</span>)&nbsp;env&nbsp;expr&nbsp;(<span class="constructor">PCompose</span>(a,&nbsp;<span class="constructor">PCompose</span>(b,&nbsp;c)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">PCompose</span>&nbsp;(pf,&nbsp;pg))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;expr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EFunction</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;({def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;<span class="constructor">EApplication</span>(e1,&nbsp;e2)];&nbsp;env&nbsp;=&nbsp;envi})&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;e1&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EVariable</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EVariable</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">EFunction</span>&nbsp;_)&nbsp;<span class="keyword">as</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="constructor">EFunction</span>({def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;e2];&nbsp;env&nbsp;=&nbsp;envi&nbsp;})&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;f&nbsp;pf)&nbsp;@&nbsp;(matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;g&nbsp;pg)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">PIdentity</span>)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;expr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">EFunction</span>({def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;<span class="constructor">EVariable</span>&nbsp;v']})&nbsp;<span class="keyword">when</span>&nbsp;v&nbsp;=&nbsp;v'&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">PConst</span>&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;expr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">EFunction</span>({def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;e]})&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fv&nbsp;=&nbsp;free_vars&nbsp;e&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">StringSet</span>.mem&nbsp;v&nbsp;fv&nbsp;<span class="keyword">then</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;e&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">PIsnum</span>&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;expr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">ENum</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;expr&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(expr,&nbsp;<span class="constructor">PWhen</span>(cond,&nbsp;p))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;expr&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;env'&nbsp;=&nbsp;multi_add_env&nbsp;r&nbsp;env&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;eval&nbsp;env'&nbsp;cond&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_,&nbsp;(<span class="constructor">EBoolean</span>&nbsp;<span class="keyword">true</span>)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">MatchingFailure</span><br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Evaluate top level definitions that change the environment globally.
<p>
<ul>
<li><code class="code"><span class="keyword">let</span> ... = ...;;</code></li>
<li><code class="code">declare ...;</code></li>
<li><code class="code"><span class="keyword">open</span> ...;</code>
</li>
</ul>
*)</span></td></tr></table><code class="code"><br>
<span class="keyword">and</span>&nbsp;eval&nbsp;env&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">ELet</span>&nbsp;(def,&nbsp;<span class="constructor">None</span>)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(env',&nbsp;_)&nbsp;=&nbsp;eval_definition&nbsp;env&nbsp;def<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;(env',&nbsp;<span class="constructor">EUnit</span>)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EDeclare</span>(var,&nbsp;<span class="constructor">None</span>)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;env'&nbsp;=&nbsp;add_env&nbsp;(var,&nbsp;(<span class="constructor">None</span>,&nbsp;<span class="constructor">None</span>))&nbsp;env<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;(env',&nbsp;<span class="constructor">EUnit</span>)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EOpen</span>&nbsp;(m,&nbsp;<span class="constructor">None</span>)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;env'&nbsp;=&nbsp;open_fun_module&nbsp;m&nbsp;env<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;(env',&nbsp;<span class="constructor">EUnit</span>)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;expr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(env,&nbsp;eval'&nbsp;env&nbsp;expr)<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Evaluate expressions that only change the environment locally.
<p>

    Recursively reduces an expression "as much as possible". Formal functions
    (see wiki) are reduced using the lambda calculus rules defined in
    <code class="code"><span class="constructor">Lambda_repl</span></code>.
<p>

    The builtin Prelude calls are also evaluated here.
<p>

    @see
    &lt;https://github.com/robocop/CamlM/wiki/%C3%89l%C3%A9ments-de-s%C3%A9mantique-du-langage-CamlM&gt;
    (in french) for details on formal functions.
*)</span></td></tr></table><code class="code"><br>
<span class="keyword">and</span>&nbsp;eval'&nbsp;env&nbsp;expr&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;expr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EVariable</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;lookup_env&nbsp;s&nbsp;env&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">Some</span>&nbsp;e,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;e<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">None</span>,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EVariable</span>&nbsp;s&nbsp;<span class="comment">(*&nbsp;If&nbsp;the&nbsp;variable&nbsp;was&nbsp;defined&nbsp;using&nbsp;declare,&nbsp;with&nbsp;no&nbsp;expression.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Only&nbsp;formal&nbsp;functions&nbsp;are&nbsp;reduced&nbsp;by&nbsp;lambda&nbsp;calculus&nbsp;rules.&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EFunction</span>&nbsp;{def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;expr];&nbsp;env&nbsp;=&nbsp;<span class="constructor">None</span>}&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="constructor">EFunction</span>&nbsp;{def&nbsp;=&nbsp;[<span class="constructor">PVariable</span>&nbsp;v,&nbsp;expr];&nbsp;env&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;env}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;is_simple_value&nbsp;f&nbsp;<span class="keyword">then</span>&nbsp;normal_order_reduct&nbsp;(replace&nbsp;env&nbsp;f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;f<br>
<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EFunction</span>&nbsp;{def&nbsp;=&nbsp;def;&nbsp;env&nbsp;=&nbsp;<span class="constructor">None</span>}&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">EFunction</span>&nbsp;{def&nbsp;=&nbsp;def;&nbsp;env&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;env}<br>
<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(f,&nbsp;e)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="comment">(*&nbsp;On&nbsp;evalue&nbsp;quelques&nbsp;primitives&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f',&nbsp;x'&nbsp;=&nbsp;(eval'&nbsp;env&nbsp;f,&nbsp;eval'&nbsp;env&nbsp;e)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;f',&nbsp;x'&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"+"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">ENum</span>&nbsp;(<span class="constructor">Int32</span>.add&nbsp;x&nbsp;y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"*"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">ENum</span>&nbsp;(<span class="constructor">Int32</span>.mul&nbsp;x&nbsp;y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"/"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Int32</span>.rem&nbsp;x&nbsp;y&nbsp;=&nbsp;<span class="constructor">Int32</span>.zero&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">ENum</span>&nbsp;(<span class="constructor">Int32</span>.div&nbsp;x&nbsp;y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">EApplication</span>(f',&nbsp;x')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EVariable</span>&nbsp;<span class="string">"-"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">ENum</span>&nbsp;(<span class="constructor">Int32</span>.neg&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"^"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keyword">when</span>&nbsp;(<span class="constructor">Int32</span>.compare&nbsp;y&nbsp;<span class="constructor">Int32</span>.zero)&nbsp;&gt;=&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">ENum</span>&nbsp;(puis&nbsp;x&nbsp;y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"mod"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">ENum</span>&nbsp;(<span class="constructor">Int32</span>.rem&nbsp;x&nbsp;y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"=="</span>,&nbsp;a),&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EBoolean</span>&nbsp;(a&nbsp;=&nbsp;b)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"&amp;&amp;"</span>,&nbsp;<span class="constructor">EBoolean</span>&nbsp;x),&nbsp;<span class="constructor">EBoolean</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EBoolean</span>&nbsp;(x<span class="keywordsign">&amp;&amp;</span>y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"||"</span>,&nbsp;<span class="constructor">EBoolean</span>&nbsp;x),&nbsp;<span class="constructor">EBoolean</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EBoolean</span>&nbsp;(x<span class="keywordsign">||</span>y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"&lt;="</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EBoolean</span>&nbsp;(x&lt;=y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"&gt;="</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EBoolean</span>&nbsp;(x&gt;=y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"&lt;"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EBoolean</span>&nbsp;(x&lt;y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"&gt;"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x),&nbsp;<span class="constructor">ENum</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EBoolean</span>&nbsp;(x&gt;y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EApplication</span>(<span class="constructor">EVariable</span>&nbsp;<span class="string">"++"</span>,&nbsp;<span class="constructor">EString</span>&nbsp;x),&nbsp;<span class="constructor">EString</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EString</span>&nbsp;(x^y)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EVariable</span>&nbsp;<span class="string">"string_of_int"</span>,&nbsp;<span class="constructor">ENum</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EString</span>&nbsp;(<span class="constructor">Int32</span>.to_string&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EFunction</span>&nbsp;{def&nbsp;=&nbsp;def;&nbsp;env&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;env_f},&nbsp;arg&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval_application&nbsp;env_f&nbsp;def&nbsp;arg<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EApplication</span>(f,&nbsp;e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EApplication</span>(f',&nbsp;x')<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EPair</span>(e1,&nbsp;e2)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">EPair</span>(eval'&nbsp;env&nbsp;e1,&nbsp;eval'&nbsp;env&nbsp;e2)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">ECons</span>(e1,&nbsp;e2)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">ECons</span>(eval'&nbsp;env&nbsp;e1,&nbsp;eval'&nbsp;env&nbsp;e2)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">ESome</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">ESome</span>&nbsp;(eval'&nbsp;env&nbsp;e)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EOpen</span>&nbsp;(m,&nbsp;<span class="constructor">Some</span>&nbsp;expr)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;env'&nbsp;=&nbsp;open_fun_module&nbsp;m&nbsp;env<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;eval'&nbsp;env'&nbsp;expr&nbsp;<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">ELet</span>(def,&nbsp;<span class="constructor">Some</span>&nbsp;corps)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval'&nbsp;(fst&nbsp;(eval_definition&nbsp;env&nbsp;def))&nbsp;corps<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EDeclare</span>(var,&nbsp;<span class="constructor">Some</span>&nbsp;corps)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;env'&nbsp;=&nbsp;add_env&nbsp;(var,&nbsp;(<span class="constructor">None</span>,&nbsp;<span class="constructor">None</span>))&nbsp;env<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;eval'&nbsp;env'&nbsp;corps<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;r<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Evaluate a function application by matching the argument with the function
    pattern. The environment is extended with the results from <code class="code">matching</code> and the
    function call is evaluated within this environment.
  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">and</span>&nbsp;eval_application&nbsp;env&nbsp;case_list&nbsp;argument&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;case_list&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Error</span>&nbsp;<span class="string">"Pattern&nbsp;matching&nbsp;failure"</span>)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(pattern,&nbsp;expr)&nbsp;::&nbsp;rest&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;extended_env&nbsp;=&nbsp;multi_add_env&nbsp;(matching&nbsp;(<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>)&nbsp;env&nbsp;argument&nbsp;pattern)&nbsp;env<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;eval'&nbsp;extended_env&nbsp;expr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">MatchingFailure</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;eval_application&nbsp;env&nbsp;rest&nbsp;argument<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Evaluate a function definition. Builds a closure in the case of a
    recursive function, and uses the standard <code class="code">eval'</code> function otherwise.
  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">and</span>&nbsp;eval_definition&nbsp;curr_env&nbsp;def&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;def.recursive&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;value&nbsp;=&nbsp;eval'&nbsp;curr_env&nbsp;def.expr&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;curr_env'&nbsp;=&nbsp;add_env&nbsp;(def.name,&nbsp;(<span class="constructor">Some</span>&nbsp;value,&nbsp;<span class="constructor">None</span>))&nbsp;curr_env<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;(curr_env',&nbsp;value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="comment">(*&nbsp;Recursive&nbsp;function&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;def.expr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">EFunction</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;closure&nbsp;=&nbsp;{def&nbsp;=&nbsp;f.def;&nbsp;env&nbsp;=&nbsp;<span class="constructor">None</span>&nbsp;}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;new_entry&nbsp;=&nbsp;(def.name,&nbsp;(<span class="constructor">Some</span>&nbsp;(<span class="constructor">EFunction</span>&nbsp;closure),&nbsp;<span class="constructor">None</span>))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;extended_env&nbsp;=&nbsp;add_env&nbsp;new_entry&nbsp;curr_env&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;closure.env&nbsp;&lt;-&nbsp;<span class="constructor">Some</span>&nbsp;extended_env;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(extended_env,&nbsp;<span class="constructor">EFunction</span>&nbsp;closure)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Error</span>&nbsp;<span class="string">"Non-functionnal&nbsp;recursive&nbsp;let&nbsp;definition"</span>)<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Evaluate a list of expressions, keeping the environment in between the
    calls.
  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">and</span>&nbsp;do_eval&nbsp;env&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;env<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;x&nbsp;::&nbsp;xs&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(env',&nbsp;_)&nbsp;=&nbsp;eval&nbsp;env&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;do_eval&nbsp;env'&nbsp;xs<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** See <code class="code"><span class="constructor">Modules</span>.open_module</code> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">and</span>&nbsp;open_fun_module&nbsp;m&nbsp;env&nbsp;=&nbsp;open_module&nbsp;do_eval&nbsp;m&nbsp;env<br>
<br>
</code></body></html>